<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Classroom</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <style>
        body {
            overflow: hidden;
            /* Prevent scroll for full app feel */
        }

        .classroom-layout {
            display: grid;
            grid-template-columns: 1fr 350px;
            /* Wider sidebar for assignments */
            height: 100vh;
        }

        .main-stage {
            padding: 24px;
            display: flex;
            flex-direction: column;
            background: #000;
            color: white;
            position: relative;
        }

        .sidebar-right {
            background: var(--sidebar-bg);
            border-left: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .video-wrapper {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        video {
            width: 100%;
            height: 100%;
            max-height: 80vh;
            object-fit: contain;
        }

        .controls-bar {
            padding: 16px;
            display: flex;
            justify-content: center;
            gap: 16px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            margin-top: 16px;
        }

        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .message {
            font-size: 14px;
            padding: 8px;
            background: var(--bg-color);
            border-radius: 4px;
            border: 1px solid var(--border-color);
        }

        .chat-input-area {
            padding: 16px;
            border-top: 1px solid var(--border-color);
        }

        .tab-header {
            display: flex;
            border-bottom: 1px solid var(--border-color);
        }

        .tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            font-weight: 600;
            font-size: 13px;
        }

        .tab.active {
            border-bottom: 2px solid var(--accent-color);
            color: var(--accent-color);
        }

        /* Assignment Styles */
        .assignment-item {
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-color);
        }

        .assignment-item h4 {
            margin-bottom: 4px;
            font-size: 15px;
        }

        .assignment-item p {
            font-size: 13px;
            color: #666;
            margin-bottom: 8px;
        }
    </style>
</head>

<body>
    <div class="classroom-layout">
        <!-- Main Stage (Video) -->
        <div class="main-stage">
            <div style="margin-bottom: 16px; display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <a href="/static/pages/dashboard.html"
                        style="color: white; text-decoration: none; margin-right: 16px;">â¬… Back</a>
                    <span id="class-name" style="font-weight: 600; font-size: 18px;">Loading...</span>
                </div>
                <div id="status-badge" style="padding: 4px 8px; background: #333; border-radius: 4px; font-size: 12px;">
                    Offline</div>
            </div>

            <div class="video-wrapper">
                <video id="main-video" autoplay playsinline></video>
                <div id="placeholder" style="position: absolute; color: #666;">Waiting for stream...</div>
            </div>

            <div class="controls-bar" id="controls">
                <!-- Injected by JS -->
            </div>
            <div id="debug-log"
                style="margin-top: 10px; font-size: 10px; color: #aaa; max-height: 100px; overflow-y: auto; background: rgba(0,0,0,0.5); padding: 8px; border-radius: 4px; display: none;">
                <div>--- Debug Log ---</div>
            </div>
        </div>

        <!-- Right Sidebar (Chat/People/Assignments) -->
        <div class="sidebar-right">
            <div class="tab-header">
                <div class="tab active" onclick="switchTab('chat')">Chat</div>
                <div class="tab" onclick="switchTab('people')">People</div>
                <div class="tab" onclick="switchTab('assignments')">Classwork</div>
            </div>

            <!-- Chat Panel -->
            <div id="chat-panel" class="chat-container">
                <div class="chat-messages" id="chat-messages">
                    <div class="message" style="color: #666; text-align: center;">Welcome to the class chat!</div>
                </div>
                <div class="chat-input-area">
                    <input type="text" id="chat-input" placeholder="Type a message..." onkeypress="handleChat(event)">
                </div>
            </div>

            <!-- People Panel -->
            <div id="people-panel" class="chat-container" style="display: none; padding: 16px;">
                <h3>Participants</h3>
                <ul id="participants-list" style="list-style: none; margin-top: 16px;">
                    <!-- List -->
                </ul>
            </div>

            <!-- Assignments Panel -->
            <div id="assignments-panel" class="chat-container" style="display: none; overflow-y: auto;">
                <div
                    style="padding: 16px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;">
                    <h3>Assignments</h3>
                    <button id="new-asg-btn" style="display: none; font-size: 12px; padding: 4px 8px;"
                        onclick="openModal('createAsgModal')">+ New</button>
                </div>
                <div id="assignments-list">
                    <!-- List -->
                </div>
            </div>
        </div>
    </div>

    <!-- Create Assignment Modal -->
    <div id="createAsgModal" class="modal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; z-index: 1000;">
        <div
            style="background: var(--bg-color); padding: 24px; border-radius: 8px; width: 400px; border: 1px solid var(--border-color);">
            <h2>New Assignment</h2>
            <div class="form-group" style="margin-top: 16px;">
                <label>Title</label>
                <input type="text" id="asg-title" style="width: 100%; padding: 8px;">
            </div>
            <div class="form-group" style="margin-top: 16px;">
                <label>Description</label>
                <textarea id="asg-desc" style="width: 100%; padding: 8px; height: 80px;"></textarea>
            </div>
            <div class="form-group" style="margin-top: 16px;">
                <label>Due Date</label>
                <input type="date" id="asg-date" style="width: 100%; padding: 8px;">
            </div>
            <div style="margin-top: 24px; display: flex; gap: 8px; justify-content: flex-end;">
                <button onclick="closeModal('createAsgModal')"
                    style="background: transparent; color: var(--text-color); border: 1px solid var(--border-color);">Cancel</button>
                <button onclick="createAssignment()">Create</button>
            </div>
        </div>
    </div>

    <!-- Submit Assignment Modal -->
    <div id="submitAsgModal" class="modal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; z-index: 1000;">
        <div
            style="background: var(--bg-color); padding: 24px; border-radius: 8px; width: 400px; border: 1px solid var(--border-color);">
            <h2>Submit Work</h2>
            <input type="hidden" id="submit-asg-id">
            <div class="form-group" style="margin-top: 16px;">
                <label>Upload File</label>
                <input type="file" id="submit-file" style="width: 100%; padding: 8px;">
            </div>
            <div style="margin-top: 24px; display: flex; gap: 8px; justify-content: flex-end;">
                <button onclick="closeModal('submitAsgModal')"
                    style="background: transparent; color: var(--text-color); border: 1px solid var(--border-color);">Cancel</button>
                <button onclick="submitWork()">Upload</button>
            </div>
        </div>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const classId = urlParams.get('id');
        let currentUser = null;
        let peer = null;
        let conn = null;
        let connections = [];
        let localStream = null;

        function log(msg) {
            console.log('[App]', msg);
            const logDiv = document.getElementById('debug-log');
            logDiv.style.display = 'block';
            const entry = document.createElement('div');
            entry.innerText = `> ${msg}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        // --- Initialization ---
        async function init() {
            const token = localStorage.getItem('token');
            if (!token) window.location.href = '/login';

            try {
                const userRes = await fetch('/users/me', { headers: { 'Authorization': 'Bearer ' + token } });
                if (!userRes.ok) throw new Error('Auth failed');
                currentUser = await userRes.json();

                const classRes = await fetch(`/classes/${classId}`, { headers: { 'Authorization': 'Bearer ' + token } });
                if (classRes.ok) {
                    const classInfo = await classRes.json();
                    document.getElementById('class-name').innerText = classInfo.name;
                }

                setupUI();
                initPeer();
                loadAssignments(); // Load assignments on init

            } catch (err) {
                console.error(err);
                alert('Error loading classroom.');
            }
        }

        function setupUI() {
            const controls = document.getElementById('controls');
            if (currentUser.role === 'teacher' || currentUser.role === 'admin') {
                controls.innerHTML = `<button onclick="startStream()" style="background: #e03e3e; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">Go Live ðŸ”´</button>`;
                document.getElementById('new-asg-btn').style.display = 'block';
            } else {
                controls.innerHTML = `<button onclick="joinStream()" style="background: var(--accent-color); color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">Join Stream ðŸ“º</button>`;
            }
            addParticipant(currentUser.email + (currentUser.role === 'teacher' ? ' (Teacher)' : ''));
        }

        // --- Assignments Logic ---
        async function loadAssignments() {
            const token = localStorage.getItem('token');
            try {
                const res = await fetch(`/classes/${classId}/assignments`, {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                const assignments = await res.json();
                const list = document.getElementById('assignments-list');

                list.innerHTML = assignments.map(a => `
                    <div class="assignment-item">
                        <div style="display:flex; justify-content:space-between;">
                            <h4>${a.title}</h4>
                            ${currentUser.role === 'student' ?
                        `<button onclick="openSubmit('${a._id}')" style="font-size:11px; padding:2px 6px;">Submit</button>` :
                        `<span style="font-size:11px; color:#888;">Teacher View</span>`
                    }
                        </div>
                        <p>${a.description}</p>
                        <div style="font-size: 11px; color: #888;">Due: ${a.due_date || 'None'}</div>
                    </div>
                `).join('');
            } catch (e) { console.error(e); }
        }

        async function createAssignment() {
            const title = document.getElementById('asg-title').value;
            const desc = document.getElementById('asg-desc').value;
            const date = document.getElementById('asg-date').value;
            const token = localStorage.getItem('token');

            try {
                const res = await fetch('/assignments/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    },
                    body: JSON.stringify({
                        class_id: classId,
                        title,
                        description: desc,
                        due_date: date
                    })
                });
                if (res.ok) {
                    closeModal('createAsgModal');
                    loadAssignments();
                }
            } catch (e) { console.error(e); }
        }

        function openSubmit(id) {
            document.getElementById('submit-asg-id').value = id;
            openModal('submitAsgModal');
        }

        async function submitWork() {
            const id = document.getElementById('submit-asg-id').value;
            const fileInput = document.getElementById('submit-file');
            const token = localStorage.getItem('token');

            if (fileInput.files.length === 0) return;

            const formData = new FormData();
            formData.append('file', fileInput.files[0]);

            try {
                const res = await fetch(`/assignments/${id}/submit`, {
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + token },
                    body: formData
                });
                if (res.ok) {
                    closeModal('submitAsgModal');
                    alert('Submitted successfully!');
                } else {
                    alert('Submission failed');
                }
            } catch (e) { console.error(e); }
        }

        // --- PeerJS Logic ---
        function initPeer() {
            log('Initializing PeerJS...');
            if (currentUser.role === 'teacher' || currentUser.role === 'admin') {
                peer = new Peer(classId, { debug: 2 });
                peer.on('open', (id) => {
                    log('Peer Open. ID: ' + id);
                    updateStatus('Ready to Stream');
                });
                peer.on('error', (err) => {
                    log('Peer Error: ' + err.type);
                    if (err.type === 'unavailable-id') {
                        alert('Session ID is taken. Someone else (or a previous tab) is already streaming. Close other tabs and refresh.');
                    } else {
                        alert('Live Stream Error: ' + err.type);
                    }
                });
                peer.on('connection', (c) => {
                    log('Incoming connection from ' + c.peer);
                    connections.push(c);
                    c.on('data', (data) => {
                        handleData(data);
                        connections.forEach(conn => { if (conn.peer !== c.peer) conn.send(data); });
                    });
                });

                // Handle incoming calls (Student joining stream)
                peer.on('call', (call) => {
                    log('Incoming call from ' + call.peer);
                    if (localStream) {
                        log('Answering call...');
                        call.answer(localStream);
                    } else {
                        log('Call received but stream not ready.');
                    }
                });
            } else {
                peer = new Peer(null, { debug: 2 });
                peer.on('open', (id) => {
                    log('Peer Open. ID: ' + id);
                    updateStatus('Ready to Join');
                });
                peer.on('error', (err) => {
                    log('Peer Error: ' + err.type);
                    if (err.type === 'peer-unavailable') {
                        alert('Stream not live. The teacher has not started the session yet.');
                    } else {
                        alert('Connection Error: ' + err.type);
                    }
                });
            }

            // Cleanup on close
            window.onbeforeunload = () => {
                if (peer) peer.destroy();
            };
        }

        async function startStream() {
            log('Starting stream...');
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                log('Camera access granted.');
                document.getElementById('main-video').srcObject = localStream;
                document.getElementById('main-video').muted = true;
                document.getElementById('placeholder').style.display = 'none';
                updateStatus('Live ðŸ”´');
                // Notify connected students
                connections.forEach(c => c.send({ type: 'stream-started' }));
            } catch (err) {
                log('Camera Error: ' + err.message);
                console.error(err);
                alert('Camera error: ' + err.message);
            }
        }

        function joinStream() {
            log('Joining stream (Target: ' + classId + ')...');
            updateStatus('Connecting...');

            // Data Connection
            if (!conn) {
                conn = peer.connect(classId);
                conn.on('open', () => {
                    log('Data connection established.');
                    updateStatus('Connected');
                    conn.send({ type: 'join', user: currentUser.email });
                    callTeacher();
                });
                conn.on('error', (err) => log('Data Conn Error: ' + err));
                conn.on('data', (data) => handleData(data));
            } else {
                callTeacher();
            }
        }

        let currentCall = null;

        function createDummyStream() {
            const canvas = document.createElement('canvas');
            canvas.width = 1;
            canvas.height = 1;
            const stream = canvas.captureStream();
            return stream;
        }

        function callTeacher() {
            if (currentCall) currentCall.close();
            log('Calling teacher...');

            const dummyStream = createDummyStream();
            const call = peer.call(classId, dummyStream);
            currentCall = call;

            call.on('stream', (remoteStream) => {
                log('Remote stream received!');
                const video = document.getElementById('main-video');
                video.srcObject = remoteStream;
                video.play().catch(e => log('Play Error: ' + e));
                document.getElementById('placeholder').style.display = 'none';
                updateStatus('Watching ðŸŸ¢');
            });

            call.on('error', (err) => log('Call Error: ' + err));
            call.on('close', () => log('Call Closed'));

            // Debug ICE state
            if (call.peerConnection) {
                call.peerConnection.oniceconnectionstatechange = () => {
                    log('ICE State: ' + call.peerConnection.iceConnectionState);
                };
            }
        }

        function handleData(data) {
            if (data.type === 'chat') addMessage(data.user, data.text);
            else if (data.type === 'join') addParticipant(data.user);
            else if (data.type === 'stream-started') {
                log('Teacher started stream. Connecting...');
                callTeacher();
            }
        }

        function handleChat(e) {
            if (e.key === 'Enter') {
                const input = document.getElementById('chat-input');
                const text = input.value;
                if (!text) return;
                const msg = { type: 'chat', user: currentUser.email, text: text };
                addMessage('Me', text);
                if (currentUser.role === 'teacher') connections.forEach(c => c.send(msg));
                else if (conn) conn.send(msg);
                input.value = '';
            }
        }

        function addMessage(user, text) {
            const div = document.createElement('div');
            div.className = 'message';
            div.innerHTML = `<strong>${user}:</strong> ${text}`;
            const container = document.getElementById('chat-messages');
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        function addParticipant(name) {
            const li = document.createElement('li');
            li.innerText = name;
            document.getElementById('participants-list').appendChild(li);
        }

        function updateStatus(text) { document.getElementById('status-badge').innerText = text; }

        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.chat-container').forEach(c => c.style.display = 'none');

            if (tab === 'chat') {
                document.getElementById('chat-panel').style.display = 'flex';
                document.querySelectorAll('.tab')[0].classList.add('active');
            } else if (tab === 'people') {
                document.getElementById('people-panel').style.display = 'block';
                document.querySelectorAll('.tab')[1].classList.add('active');
            } else if (tab === 'assignments') {
                document.getElementById('assignments-panel').style.display = 'block';
                document.querySelectorAll('.tab')[2].classList.add('active');
            }
        }

        function openModal(id) { document.getElementById(id).style.display = 'flex'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }

        init();
    </script>
</body>

</html>